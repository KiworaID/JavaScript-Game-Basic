<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Neon Tactics: Cyber Face & Audio</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* UI LAYERS */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 5; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); pointer-events: auto; }
        
        /* HUD */
        .top-hud { display: flex; justify-content: space-between; padding: 30px 50px; }
        .stat-box { width: 300px; background: rgba(0,0,0,0.8); border: 2px solid #555; padding: 10px; transform: skewX(-10deg); position: relative; }
        .hp-bar-bg { width: 100%; height: 20px; background: #333; margin-top: 5px; }
        .hp-bar-fill { height: 100%; transition: width 0.5s ease-out; }
        .p1-color { color: #00ffff; background: #00ffff; box-shadow: 0 0 10px #00ffff; }
        .p2-color { color: #ff0055; background: #ff0055; box-shadow: 0 0 10px #ff0055; }
        
        /* TEXT LOG */
        #battle-log { text-align: center; color: #fff; font-size: 24px; text-shadow: 0 0 10px #00ffff; font-weight: bold; margin-top: 50px; letter-spacing: 2px; }

        /* BUTTONS */
        .bottom-hud { display: flex; justify-content: center; padding-bottom: 40px; pointer-events: auto; gap: 20px; }
        .action-btn {
            background: rgba(0, 20, 30, 0.9); border: 2px solid #00ffff; color: #fff;
            width: 100px; height: 100px; border-radius: 15px; font-size: 12px; font-weight: bold; 
            cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .action-btn:hover { background: #00ffff; color: #000; transform: scale(1.1); box-shadow: 0 0 25px #00ffff; }
        .action-btn:active { transform: scale(0.95); }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); transform: none; box-shadow: none; border-color: #444; }
        .btn-icon { font-size: 30px; margin-bottom: 5px; }

        /* MENUS */
        h1 { font-size: 50px; color: #fff; margin-bottom: 20px; text-transform: uppercase; text-shadow: 4px 4px 0 #00ffff; }
        .menu-btn { padding: 15px 50px; font-size: 24px; background: transparent; border: 3px solid #fff; color: #fff; cursor: pointer; transition: 0.3s; font-family: inherit; font-weight: bold; text-transform: uppercase; }
        .menu-btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }
        
        /* INVENTORY */
        #inventory-modal {
            position: absolute; bottom: 160px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.95); border: 2px solid #00ffff; padding: 15px;
            display: none; pointer-events: auto; grid-template-columns: repeat(3, 1fr); gap: 10px; z-index: 10;
        }
        .inv-item { border: 1px solid #555; padding: 10px; color: #fff; cursor: pointer; text-align: center; font-size: 14px; }
        .inv-item:hover { border-color: #00ffff; background: #222; }

    </style>
</head>
<body>

    <!-- 3D CANVAS -->
    <div id="canvas-container"></div>

    <!-- UI LAYER -->
    <div id="ui-layer">
        <div class="top-hud">
            <div class="stat-box" style="border-color: #00ffff;">
                <div style="display:flex; justify-content:space-between;">
                    <span class="p1-color" style="background:none;">PLAYER</span>
                    <span id="p1-hp-text" style="color:#fff;">100/100</span>
                </div>
                <div class="hp-bar-bg"><div id="p1-bar" class="hp-bar-fill p1-color" style="width: 100%;"></div></div>
            </div>
            <div class="stat-box" style="border-color: #ff0055;">
                <div style="display:flex; justify-content:space-between;">
                    <span class="p2-color" style="background:none;">CYBER BOT</span>
                    <span id="p2-hp-text" style="color:#fff;">120/120</span>
                </div>
                <div class="hp-bar-bg"><div id="p2-bar" class="hp-bar-fill p2-color" style="width: 100%;"></div></div>
            </div>
        </div>

        <div id="battle-log">WAITING FOR START...</div>

        <div class="bottom-hud">
            <button class="action-btn" onclick="game.playerAction('attack')">
                <span class="btn-icon">‚öîÔ∏è</span>ATTACK
            </button>
            <button class="action-btn" onclick="game.playerAction('defend')">
                <span class="btn-icon">üõ°Ô∏è</span>DEFEND
            </button>
            <button class="action-btn" onclick="game.toggleInventory()">
                <span class="btn-icon">üéí</span>ITEMS
            </button>
        </div>
        
        <div id="inventory-modal"></div>
    </div>

    <!-- SCREENS -->
    <div id="start-screen" class="overlay">
        <h1>Neon Tactics</h1>
        <button class="menu-btn" onclick="game.initAudioAndStart()">START MISSION</button>
    </div>

    <div id="pause-screen" class="overlay" style="display: none;">
        <h1>PAUSED</h1>
        <button class="menu-btn" onclick="game.togglePause()">RESUME</button>
        <p style="color: #888; margin-top: 20px;">Press ESC to Resume</p>
    </div>

    <div id="end-screen" class="overlay" style="display: none;">
        <h1 id="end-title">VICTORY</h1>
        <button class="menu-btn" onclick="location.reload()">REMATCH</button>
    </div>

    <!-- LIB -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        /**
         * 1. AUDIO SYSTEM (Synthesizer)
         * Membuat suara menggunakan Oscillator tanpa file mp3.
         */
        const AudioSys = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration, vol = 0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playBGM: function() {
                // Drone Background sederhana
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.value = 50; // Low frequency
                // LFO untuk modulasi filter
                const lfo = this.ctx.createOscillator();
                lfo.frequency.value = 0.2;
                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 500;
                
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 600;

                lfo.connect(lfoGain);
                lfoGain.connect(filter.frequency);
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);
                
                gain.gain.value = 0.03; // Sangat pelan
                osc.start();
                lfo.start();
            },
            sfx: {
                click: () => AudioSys.playTone(800, 'sine', 0.1, 0.05),
                attack: () => {
                    // Swipe sound noise-ish
                    if(!AudioSys.ctx) return;
                    const osc = AudioSys.ctx.createOscillator();
                    const gain = AudioSys.ctx.createGain();
                    osc.frequency.setValueAtTime(400, AudioSys.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, AudioSys.ctx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.1, AudioSys.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0, AudioSys.ctx.currentTime + 0.2);
                    osc.connect(gain);
                    gain.connect(AudioSys.ctx.destination);
                    osc.start();
                    osc.stop(AudioSys.ctx.currentTime + 0.2);
                },
                hit: () => AudioSys.playTone(100, 'square', 0.3, 0.2), // Punchy
                buff: () => AudioSys.playTone(600, 'triangle', 0.5, 0.1),
                win: () => {
                    let now = AudioSys.ctx.currentTime;
                    [523, 659, 783, 1046].forEach((f, i) => { // C Major Arpeggio
                        const osc = AudioSys.ctx.createOscillator();
                        const g = AudioSys.ctx.createGain();
                        osc.frequency.value = f;
                        osc.type = 'square';
                        g.gain.setValueAtTime(0.1, now + i*0.1);
                        g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.5);
                        osc.connect(g);
                        g.connect(AudioSys.ctx.destination);
                        osc.start(now + i*0.1);
                        osc.stop(now + i*0.1 + 0.5);
                    });
                }
            }
        };

        /**
         * 2. FACE TEXTURE GENERATOR
         * Menggambar wajah ke Canvas HTML lalu dijadikan Texture.
         */
        function generateFaceTexture(colorHex, expression = 'normal') {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');

            // Background (Sama dengan warna kulit tapi lebih gelap dikit)
            ctx.fillStyle = colorHex; 
            ctx.fillRect(0,0,256,256);
            
            // Shading frame
            ctx.strokeStyle = "rgba(0,0,0,0.5)";
            ctx.lineWidth = 20;
            ctx.strokeRect(0,0,256,256);

            // Set warna fitur wajah (putih bersinar)
            ctx.fillStyle = "#ffffff";
            ctx.shadowColor = "#ffffff";
            ctx.shadowBlur = 20;

            // Mata
            if (expression === 'normal') {
                ctx.fillRect(50, 80, 60, 20); // Kiri
                ctx.fillRect(146, 80, 60, 20); // Kanan
            } else if (expression === 'angry') {
                // Mata miring (marah)
                ctx.save();
                ctx.translate(80, 90); ctx.rotate(Math.PI/6); ctx.fillRect(-30, -10, 60, 20);
                ctx.restore();
                ctx.save();
                ctx.translate(176, 90); ctx.rotate(-Math.PI/6); ctx.fillRect(-30, -10, 60, 20);
                ctx.restore();
            } else if (expression === 'pain') {
                // Mata X (Sakit)
                ctx.font = "80px Arial";
                ctx.fillText("X", 55, 110);
                ctx.fillText("X", 155, 110);
            }

            // Mulut
            if (expression === 'normal') {
                ctx.fillRect(80, 160, 96, 10); // Garis datar
            } else if (expression === 'angry') {
                ctx.fillRect(80, 160, 96, 30); // Mulut terbuka kotak
            } else if (expression === 'pain') {
                ctx.beginPath();
                ctx.arc(128, 180, 20, 0, Math.PI*2); // Mulut O
                ctx.fill();
            }

            return new THREE.CanvasTexture(canvas);
        }

        /**
         * 3. GAME OBJECT
         */
        const game = {
            state: { playerTurn: true, gameOver: false, paused: false },
            player: { hp: 100, maxHp: 100, dmg: 15, inventory: [{name:"Medkit", val:40, qty:2, icon:"üíä"}, {name:"Grenade", val:25, qty:1, icon:"üí£"}] },
            enemy: { hp: 120, maxHp: 120, dmg: 10 },
            objects: { p1: null, p2: null }, // ThreeJS Meshes
            textures: {}, // Cache texture

            initAudioAndStart: function() {
                AudioSys.init();
                AudioSys.playBGM();
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('battle-log').innerText = "YOUR TURN";
            },

            togglePause: function() {
                if(this.state.gameOver) return;
                this.state.paused = !this.state.paused;
                document.getElementById('pause-screen').style.display = this.state.paused ? 'flex' : 'none';
                if(AudioSys.ctx && this.state.paused) AudioSys.ctx.suspend();
                if(AudioSys.ctx && !this.state.paused) AudioSys.ctx.resume();
            },

            toggleInventory: function() {
                if(!this.state.playerTurn || this.state.paused) return;
                AudioSys.sfx.click();
                const modal = document.getElementById('inventory-modal');
                if(modal.style.display === 'grid') { modal.style.display = 'none'; return; }
                
                modal.innerHTML = '';
                this.player.inventory.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'inv-item';
                    div.innerHTML = `${item.icon} ${item.name}<br><small>x${item.qty}</small>`;
                    div.onclick = () => this.useItem(i);
                    modal.appendChild(div);
                });
                modal.style.display = 'grid';
            },

            setFace: function(unit, expr) {
                // unit = 'p1' or 'p2', expr = 'normal','angry','pain'
                const color = unit === 'p1' ? '#00ffff' : '#ff0055';
                const key = unit + expr;
                if(!this.textures[key]) {
                    this.textures[key] = generateFaceTexture(color, expr);
                }
                // Material Index 4 is Front (usually) depending on box UV, let's try 4 & 5
                // BoxGeometry materials: Right, Left, Top, Bottom, Front, Back
                const mesh = this.objects[unit].head;
                mesh.material[4].map = this.textures[key];
                mesh.material[4].needsUpdate = true;
            },

            playerAction: function(act) {
                if(!this.state.playerTurn || this.state.paused || this.state.gameOver) return;
                AudioSys.sfx.click();
                document.getElementById('inventory-modal').style.display = 'none';

                if(act === 'attack') {
                    this.performAttack('p1', 'p2', this.player.dmg);
                } else if(act === 'defend') {
                    document.getElementById('battle-log').innerText = "SHIELD UP!";
                    AudioSys.sfx.buff();
                    this.nextTurn();
                }
            },

            useItem: function(idx) {
                const item = this.player.inventory[idx];
                if(item.name === "Medkit") {
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + item.val);
                    AudioSys.sfx.buff();
                    this.updateHUD();
                    this.spawnParticles(this.objects.p1.group.position, 0x00ff00);
                } else if(item.name === "Grenade") {
                    this.performAttack('p1', 'p2', item.val, true); // True = grenade anim logic if needed
                }
                item.qty--;
                if(item.qty<=0) this.player.inventory.splice(idx,1);
                document.getElementById('inventory-modal').style.display = 'none';
                if(item.name !== "Grenade") this.nextTurn(); // Grenade already calls performAttack which calls nextTurn
            },

            performAttack: function(attacker, defender, dmg, isItem = false) {
                const atkObj = this.objects[attacker];
                const defObj = this.objects[defender];
                
                // 1. Change Face to Angry
                this.setFace(attacker, 'angry');
                
                // 2. Animation Move
                const dir = attacker === 'p1' ? 1 : -1;
                let step = 0;
                const interval = setInterval(() => {
                    step++;
                    // Maju
                    if(step < 10) atkObj.group.position.x += 0.3 * dir;
                    // Hit moment
                    else if(step === 10) {
                        AudioSys.sfx.attack();
                        AudioSys.sfx.hit();
                        
                        // Apply Dmg
                        if(defender === 'p1') this.player.hp -= dmg;
                        else this.enemy.hp -= dmg;
                        
                        // Visual Hit
                        this.setFace(defender, 'pain');
                        this.spawnParticles(defObj.group.position, defender === 'p1' ? 0x00ffff : 0xff0055);
                        this.updateHUD();
                        
                        // Shake Camera
                        camera.position.y -= 0.5; setTimeout(()=>camera.position.y += 0.5, 50);
                    }
                    // Mundur
                    else if(step < 20) atkObj.group.position.x -= 0.3 * dir;
                    else {
                        clearInterval(interval);
                        // Reset Faces
                        this.setFace(attacker, 'normal');
                        setTimeout(() => this.setFace(defender, 'normal'), 500);
                        this.checkWinLose();
                        if(!this.state.gameOver) this.nextTurn();
                    }
                }, 20);
            },

            aiTurn: function() {
                if(this.state.gameOver) return;
                document.getElementById('battle-log').innerText = "ENEMY ATTACKING!";
                setTimeout(() => {
                    this.performAttack('p2', 'p1', this.enemy.dmg);
                }, 1000);
            },

            nextTurn: function() {
                this.state.playerTurn = !this.state.playerTurn;
                if(this.state.playerTurn) {
                    document.getElementById('battle-log').innerText = "YOUR TURN";
                    // Enable buttons
                    document.querySelectorAll('.action-btn').forEach(b=>b.disabled=false);
                } else {
                    // Disable buttons
                    document.querySelectorAll('.action-btn').forEach(b=>b.disabled=true);
                    this.aiTurn();
                }
            },

            checkWinLose: function() {
                if(this.player.hp <= 0 || this.enemy.hp <= 0) {
                    this.state.gameOver = true;
                    const win = this.player.hp > 0;
                    document.getElementById('end-screen').style.display = 'flex';
                    document.getElementById('end-title').innerText = win ? "VICTORY" : "DEFEAT";
                    document.getElementById('end-title').style.color = win ? "#00ff00" : "#ff0000";
                    if(win) AudioSys.sfx.win();
                    
                    // Fall animation
                    const loser = win ? this.objects.p2.group : this.objects.p1.group;
                    loser.rotation.x = -Math.PI/2;
                    loser.position.y = 1;
                }
            },

            updateHUD: function() {
                const p1p = (this.player.hp/this.player.maxHp)*100;
                const p2p = (this.enemy.hp/this.enemy.maxHp)*100;
                document.getElementById('p1-bar').style.width = Math.max(0,p1p)+'%';
                document.getElementById('p1-hp-text').innerText = Math.max(0,this.player.hp)+'/'+this.player.maxHp;
                document.getElementById('p2-bar').style.width = Math.max(0,p2p)+'%';
                document.getElementById('p2-hp-text').innerText = Math.max(0,this.enemy.hp)+'/'+this.enemy.maxHp;
            },

            // ThreeJS Helper for Particles
            spawnParticles: function(pos, color) {
                for(let i=0; i<10; i++) {
                    const geo = new THREE.BoxGeometry(0.2,0.2,0.2);
                    const mat = new THREE.MeshBasicMaterial({color:color});
                    const m = new THREE.Mesh(geo, mat);
                    m.position.copy(pos);
                    m.position.y += 3; // Head height
                    m.userData = { 
                        vel: new THREE.Vector3((Math.random()-0.5), Math.random(), (Math.random()-0.5)) 
                    };
                    scene.add(m);
                    setTimeout(() => scene.remove(m), 500); // Auto remove simple
                }
            }
        };

        // --- THREE.JS INIT ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050510);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 6, 20);
        camera.lookAt(0, 3, 0);

        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5,10,5);
        scene.add(dirLight);

        // Floor
        const grid = new THREE.GridHelper(50, 50, 0x00ffff, 0x222222);
        scene.add(grid);

        // Character Creator
        function createCharacter(name, color, x) {
            const group = new THREE.Group();
            
            // Body
            const body = new THREE.Mesh(
                new THREE.BoxGeometry(2, 3, 1.5),
                new THREE.MeshStandardMaterial({color: color})
            );
            body.position.y = 1.5;
            group.add(body);

            // Head (With Faces)
            // Materials Array: Right, Left, Top, Bottom, Front, Back
            const baseMat = new THREE.MeshStandardMaterial({color: color});
            const faceMat = new THREE.MeshBasicMaterial({ map: generateFaceTexture(color, 'normal') });
            
            const materials = [baseMat, baseMat, baseMat, baseMat, faceMat, baseMat];
            
            const head = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), materials);
            head.position.y = 4.5;
            group.add(head);

            group.position.set(x, 0, 0);
            
            // Rotation tweaks so Face (Front) looks at camera
            // Default Box Front is +Z. 
            // Player (Left) needs to rotate Y to look right? No, standard view is side.
            // Let's rotate meshes to face center.
            if(x < 0) group.rotation.y = Math.PI / 2; // P1 faces Right
            else group.rotation.y = -Math.PI / 2; // P2 faces Left

            scene.add(group);
            return { group, head };
        }

        game.objects.p1 = createCharacter('Player', '#00ffff', -6);
        game.objects.p2 = createCharacter('Enemy', '#ff0055', 6);

        // Cache initial faces
        game.setFace('p1', 'normal');
        game.setFace('p2', 'normal');

        // Loop
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // Pause Listener
        window.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') game.togglePause();
        });
        
        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>